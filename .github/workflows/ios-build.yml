name: iOS Build & Test

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: latest-stable

    - name: Show Xcode Version & Available Schemes
      run: |
        xcodebuild -version
        xcodebuild -list 2>/dev/null || true

    - name: Build iOS Swift Package
      run: |
        xcodebuild build \
          -scheme ProteinTracker \
          -destination "generic/platform=iOS Simulator" \
          -derivedDataPath DerivedData

    - name: Run Unit Tests
      run: |
        xcodebuild test \
          -scheme ProteinTracker \
          -destination "platform=iOS Simulator,name=iPhone 16,OS=latest" \
          -derivedDataPath DerivedData \
          -resultBundlePath UnitTestResults.xcresult \
          -only-testing:ProteinTrackerTests

    - name: Boot Simulator
      run: |
        UDID=$(xcrun simctl list devices available | grep "iPhone 16" | grep -v "Plus\|Pro" | head -1 | grep -oE "[0-9A-F-]{36}")
        echo "SIMULATOR_UDID=$UDID" >> $GITHUB_ENV
        xcrun simctl boot "$UDID" || true
        xcrun simctl bootstatus "$UDID" -b
        echo "Booted simulator: $UDID"

    - name: Run UI Tests and Capture Screenshots
      run: |
        xcodebuild test \
          -scheme ProteinTracker \
          -destination "platform=iOS Simulator,name=iPhone 16,OS=latest" \
          -derivedDataPath DerivedData \
          -resultBundlePath UITestResults.xcresult \
          -only-testing:ProteinTrackerUITests || true

    - name: Extract Screenshots
      if: always()
      run: |
        mkdir -p Screenshots
        python3 << 'PYEOF'
import json, subprocess, os

def run(cmd):
    return subprocess.run(cmd, capture_output=True, text=True)

def run_bin(cmd):
    return subprocess.run(cmd, capture_output=True)

result = run(['xcrun', 'xcresulttool', 'get', '--path', 'UITestResults.xcresult', '--format', 'json'])
if result.returncode != 0:
    print("Could not read xcresult:", result.stderr)
    exit(0)

data = json.loads(result.stdout)
count = 0

def find_attachments(obj, depth=0):
    global count
    if depth > 20 or not isinstance(obj, (dict, list)):
        return
    if isinstance(obj, list):
        for item in obj:
            find_attachments(item, depth+1)
        return
    type_name = obj.get('_type', {}).get('_name', '')
    if type_name == 'ActionTestAttachment':
        name = obj.get('name', {}).get('_value', f'screenshot_{count}')
        uti = obj.get('uniformTypeIdentifier', {}).get('_value', '')
        ref = obj.get('payloadRef', {}).get('id', {}).get('_value', '')
        if ref and 'png' in uti:
            img = run_bin(['xcrun', 'xcresulttool', 'get', '--path', 'UITestResults.xcresult', '--id', ref])
            fname = f'Screenshots/{name}.png'
            with open(fname, 'wb') as f:
                f.write(img.stdout)
            print(f'Saved: {fname}')
            count += 1
    for v in obj.values():
        find_attachments(v, depth+1)

find_attachments(data)
print(f'Total screenshots: {count}')
PYEOF
        ls -la Screenshots/

    - name: Upload Screenshots
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: App-Screenshots
        path: Screenshots/
        if-no-files-found: warn

    - name: Upload xcresult Bundle
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: UITest-xcresult
        path: UITestResults.xcresult/

    - name: Build Status
      if: always()
      run: echo "Build and screenshot capture completed!"
