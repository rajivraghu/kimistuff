name: iOS Build & Test

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: latest-stable

    - name: Show Xcode Version & Available Schemes
      run: |
        xcodebuild -version
        xcodebuild -list 2>/dev/null || true

    - name: Build iOS Swift Package
      run: |
        xcodebuild build \
          -scheme ProteinTracker \
          -destination "generic/platform=iOS Simulator" \
          -derivedDataPath DerivedData

    - name: Run Unit Tests
      run: |
        xcodebuild test \
          -scheme ProteinTracker \
          -destination "platform=iOS Simulator,name=iPhone 16,OS=latest" \
          -derivedDataPath DerivedData \
          -resultBundlePath UnitTestResults.xcresult \
          -only-testing:ProteinTrackerTests

    - name: Boot Simulator
      run: |
        UDID=$(xcrun simctl list devices available | grep "iPhone 16" | grep -v "Plus\|Pro" | head -1 | grep -oE "[0-9A-F-]{36}")
        echo "SIMULATOR_UDID=$UDID" >> $GITHUB_ENV
        xcrun simctl boot "$UDID" || true
        xcrun simctl bootstatus "$UDID" -b
        echo "Booted simulator: $UDID"

    - name: Run UI Tests and Capture Screenshots
      run: |
        xcodebuild test \
          -scheme ProteinTracker \
          -destination "platform=iOS Simulator,name=iPhone 16,OS=latest" \
          -derivedDataPath DerivedData \
          -resultBundlePath UITestResults.xcresult \
          -only-testing:ProteinTrackerUITests || true

    - name: Extract Screenshots
      if: always()
      run: python3 .github/scripts/extract_screenshots.py

    - name: List Screenshots
      if: always()
      run: ls -la Screenshots/ || echo "No screenshots folder found"

    - name: Upload Screenshots
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: App-Screenshots
        path: Screenshots/
        if-no-files-found: warn

    - name: Upload xcresult Bundle
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: UITest-xcresult
        path: UITestResults.xcresult/

    - name: Build Status
      if: always()
      run: echo "Build and screenshot capture completed!"
