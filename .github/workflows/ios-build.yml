name: iOS Build & Test

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: latest-stable

    - name: Show Xcode Version
      run: xcodebuild -version

    - name: Build iOS Swift Package
      run: |
        xcodebuild build \
          -scheme ProteinTracker \
          -destination "generic/platform=iOS Simulator" \
          -derivedDataPath DerivedData

    - name: Run Unit Tests
      run: |
        xcodebuild test \
          -scheme ProteinTracker \
          -destination "platform=iOS Simulator,name=iPhone 16,OS=latest" \
          -derivedDataPath DerivedData \
          -resultBundlePath UnitTestResults.xcresult \
          -only-testing:ProteinTrackerTests

    - name: Boot Simulator & Take Screenshots
      run: |
        # Boot iPhone 16 simulator
        UDID=$(xcrun simctl list devices available | grep "iPhone 16" | grep -v "Plus\|Pro\|Max" | head -1 | grep -oE "[0-9A-F-]{36}")
        echo "Booting simulator: $UDID"
        xcrun simctl boot "$UDID"
        xcrun simctl bootstatus "$UDID" -b
        
        # Open Simulator.app so UI renders
        open -a Simulator --args -CurrentDeviceUDID "$UDID"
        sleep 5
        
        mkdir -p Screenshots
        
        # Screenshot 1: Home screen / SpringBoard
        xcrun simctl io "$UDID" screenshot Screenshots/01_Simulator_Homescreen.png
        echo "Captured homescreen"
        sleep 2
        
        # Build the app with a simulator destination to get a runnable .app
        xcodebuild build \
          -scheme ProteinTracker \
          -destination "platform=iOS Simulator,id=$UDID" \
          -derivedDataPath DerivedData2 \
          -configuration Debug 2>&1 | tail -5
        
        # Find the built .app
        APP_PATH=$(find DerivedData2 -name "ProteinTracker.app" -path "*/Debug-iphonesimulator/*" | head -1)
        echo "App path: $APP_PATH"
        
        if [ -n "$APP_PATH" ]; then
          # Install and launch the app
          xcrun simctl install "$UDID" "$APP_PATH"
          BUNDLE_ID=$(xcrun simctl get_app_container "$UDID" "$(plutil -convert json -o - "$APP_PATH/Info.plist" | python3 -c "import sys,json; print(json.load(sys.stdin).get('CFBundleIdentifier',''))")" 2>/dev/null || echo "")
          
          # Get bundle ID from Info.plist
          BUNDLE_ID=$(python3 -c "
        import subprocess, json
        result = subprocess.run(['plutil', '-convert', 'json', '-o', '-', '$APP_PATH/Info.plist'], capture_output=True, text=True)
        data = json.loads(result.stdout)
        print(data.get('CFBundleIdentifier', ''))
        ")
          echo "Bundle ID: $BUNDLE_ID"
          
          if [ -n "$BUNDLE_ID" ]; then
            xcrun simctl launch "$UDID" "$BUNDLE_ID"
            sleep 4
            xcrun simctl io "$UDID" screenshot Screenshots/02_App_Launch.png
            echo "Captured app launch"
            sleep 2
            xcrun simctl io "$UDID" screenshot Screenshots/03_App_Today_Tab.png
            echo "Captured today tab"
          fi
        else
          echo "No .app bundle found, capturing simulator state"
          xcrun simctl io "$UDID" screenshot Screenshots/02_Simulator_State.png
        fi
        
        echo "Screenshots captured:"
        ls -la Screenshots/

    - name: Upload Screenshots
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: App-Screenshots
        path: Screenshots/
        if-no-files-found: warn

    - name: Upload Unit Test Results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: UnitTest-xcresult
        path: UnitTestResults.xcresult/

    - name: Build Status
      if: always()
      run: echo "Build and screenshot capture completed!"
