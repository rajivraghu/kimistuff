name: iOS Build & Test

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: latest-stable

    - name: Show Xcode Version
      run: xcodebuild -version

    - name: Install xcodegen
      run: brew install xcodegen

    - name: Generate Xcode Project
      run: xcodegen generate

    - name: Run Unit Tests
      run: |
        xcodebuild test \
          -project ProteinTracker.xcodeproj \
          -scheme ProteinTracker \
          -destination "platform=iOS Simulator,name=iPhone 16,OS=latest" \
          -derivedDataPath DerivedData \
          -only-testing:ProteinTrackerTests

    - name: Build App for Simulator
      run: |
        xcodebuild build \
          -project ProteinTracker.xcodeproj \
          -scheme ProteinTracker \
          -destination "platform=iOS Simulator,name=iPhone 16,OS=latest" \
          -derivedDataPath DerivedData \
          -configuration Debug

    - name: Boot Simulator
      run: |
        UDID=$(xcrun simctl list devices available | grep "iPhone 16" | grep -v "Plus\|Pro\|Max" | head -1 | grep -oE "[0-9A-F-]{36}")
        echo "SIMULATOR_UDID=$UDID" >> $GITHUB_ENV
        xcrun simctl boot "$UDID" || true
        xcrun simctl bootstatus "$UDID" -b
        open -a Simulator --args -CurrentDeviceUDID "$UDID"
        sleep 6
        echo "Booted: $UDID"

    - name: Install & Launch App, Capture Screenshots
      run: |
        UDID=$SIMULATOR_UDID
        APP_PATH=$(find DerivedData -name "ProteinTracker.app" -path "*/Debug-iphonesimulator/*" | head -1)
        echo "App path: $APP_PATH"

        xcrun simctl install "$UDID" "$APP_PATH"

        BUNDLE_ID=$(python3 -c "
        import subprocess, json
        r = subprocess.run(['plutil', '-convert', 'json', '-o', '-', '$APP_PATH/Info.plist'], capture_output=True, text=True)
        print(json.loads(r.stdout).get('CFBundleIdentifier',''))
        ")
        echo "Bundle ID: $BUNDLE_ID"

        mkdir -p Screenshots

        # Launch app and wait for UI to render
        xcrun simctl launch "$UDID" "$BUNDLE_ID"
        sleep 6

        # Today tab (default screen)
        xcrun simctl io "$UDID" screenshot Screenshots/01_Today_Tab.png
        echo "✅ Captured: Today Tab"

        # Tap History tab (2nd tab)
        xcrun simctl io "$UDID" tap 215 830 2>/dev/null || true
        sleep 3
        xcrun simctl io "$UDID" screenshot Screenshots/02_History_Tab.png
        echo "✅ Captured: History Tab"

        # Tap Settings tab (3rd tab)
        xcrun simctl io "$UDID" tap 322 830 2>/dev/null || true
        sleep 3
        xcrun simctl io "$UDID" screenshot Screenshots/03_Settings_Tab.png
        echo "✅ Captured: Settings Tab"

        # Go back to Today tab (1st tab)
        xcrun simctl io "$UDID" tap 107 830 2>/dev/null || true
        sleep 3

        # Tap Quick Add +10g button
        xcrun simctl io "$UDID" tap 107 460 2>/dev/null || true
        sleep 2
        xcrun simctl io "$UDID" screenshot Screenshots/04_After_Quick_Add.png
        echo "✅ Captured: After Quick Add"

        # Tap + button in nav bar to open Add Entry sheet
        xcrun simctl io "$UDID" tap 370 60 2>/dev/null || true
        sleep 3
        xcrun simctl io "$UDID" screenshot Screenshots/05_Add_Entry_Sheet.png
        echo "✅ Captured: Add Entry Sheet"

        echo "--- All screenshots ---"
        ls -lh Screenshots/

    - name: Upload Screenshots
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: App-Screenshots
        path: Screenshots/
        if-no-files-found: warn

    - name: Build Status
      if: always()
      run: echo "Done!"
